name: Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # –ö–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ –ø–æ–ª–Ω–æ—á—å

jobs:
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit flask flask-sqlalchemy flask-wtf python-dotenv
        
    # 1. SAST - Bandit —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
    - name: Run Bandit SAST Scan
      run: |
        echo "üîç –ó–∞–ø—É—Å–∫ Bandit —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞..."
        bandit -r . \
          -f json -o bandit-report.json \
          --skip B101,B311,B404,B603
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
        if grep -q '"issue_severity": "HIGH"' bandit-report.json || \
           grep -q '"issue_severity": "MEDIUM"' bandit-report.json; then
          echo "‚ùå –ù–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏!"
          echo "=== –û—Ç—á–µ—Ç Bandit ==="
          cat bandit-report.json | python -m json.tool | head -100
          exit 1
        else
          echo "‚úÖ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        fi
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–µ–±–∞–≥ —Ä–µ–∂–∏–º–∞ –≤ –∫–æ–¥–µ
    - name: Check for Debug Mode
      id: debug_check
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ debug —Ä–µ–∂–∏–º–∞ –≤ –∫–æ–¥–µ..."
        if grep -r "debug=True" . --include="*.py"; then
          echo "‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω debug=True –≤ –∫–æ–¥–µ!"
          echo "debug_detected=true" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "‚úÖ Debug —Ä–µ–∂–∏–º –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–¥–µ"
          echo "debug_detected=false" >> $GITHUB_OUTPUT
        fi
    
    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ö–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤
    - name: Check for Hardcoded Secrets
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ö–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤..."
        # –ü–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
        PATTERNS="password\|secret_key\|api_key\|token\|auth"
        FOUND_SECRETS=$(grep -r -i "$PATTERNS" . --include="*.py" --include="*.env" | grep -v ".github" | grep -v "__pycache__" || true)
        
        if [ -n "$FOUND_SECRETS" ]; then
          echo "‚ö†Ô∏è  –ù–∞–π–¥–µ–Ω—ã –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:"
          echo "$FOUND_SECRETS"
          # –ù–µ —Ñ–µ–π–ª–∏–º, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ —Ñ–µ–π–ª–∏—Ç—å)
        else
          echo "‚úÖ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        fi
    
    # 4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    - name: Run Application Tests
      run: |
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –ë–î
        python create_user_table.py
        python create_test_users.py
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
        timeout 10s python -c "
        from app import app
        print('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ')
        " || echo "‚ö†Ô∏è  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è"
    
    # 5. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞
    - name: Generate Security Report
      if: always()
      run: |
        echo "üìä === –û–¢–ß–ï–¢ –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò ==="
        echo "–î–∞—Ç–∞: $(date)"
        echo "–í–µ—Ç–∫–∞: ${{ github.ref }}"
        echo "–ö–æ–º–º–∏—Ç: ${{ github.sha }}"
        echo ""
        echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
        echo "- Bandit SAST: ${{ job.status == 'success' && '‚úÖ PASS' || '‚ùå FAIL' }}"
        echo "- Debug –ø—Ä–æ–≤–µ—Ä–∫–∞: ${{ steps.debug_check.outputs.debug_detected == 'false' && '‚úÖ PASS' || '‚ùå FAIL' }}"
        echo ""
        echo "–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
        echo "1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ debug=False –≤ production"
        echo "2. –•—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è"
        echo "3. –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
        
    # 6. Upload –æ—Ç—á–µ—Ç –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
    - name: Upload Security Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: |
          bandit-report.json
        retention-days: 30