name: Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'  # ÐšÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð² Ð¿Ð¾Ð»Ð½Ð¾Ñ‡ÑŒ

jobs:
  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit flask flask-sqlalchemy flask-wtf python-dotenv
        
    # 1. SAST - Bandit ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð°Ð½Ð°Ð»Ð¸Ð·
    - name: Run Bandit SAST Scan
      id: bandit_scan
      run: |
        echo "ðŸ” Ð—Ð°Ð¿ÑƒÑÐº Bandit ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
        bandit -r . \
          -f txt -o bandit-report.txt \
          --skip B101,B404,B603  # ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
        
        # ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
        if grep -q "High severity" bandit-report.txt; then
          echo "âŒ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ HIGH ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸!"
          cat bandit-report.txt
          exit 1
        elif grep -q "Medium severity" bandit-report.txt; then
          echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ MEDIUM ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ (Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ)"
          cat bandit-report.txt
          echo "warning_detected=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾"
          echo "warning_detected=false" >> $GITHUB_OUTPUT
        fi
    
    # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð´ÐµÐ±Ð°Ð³ Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ð² ÐºÐ¾Ð´Ðµ
    - name: Check for Debug Mode
      id: debug_check
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° debug Ñ€ÐµÐ¶Ð¸Ð¼Ð° Ð² ÐºÐ¾Ð´Ðµ..."
        DEBUG_FOUND=$(grep -r "debug=True" . --include="*.py" || true)
        
        if [ -n "$DEBUG_FOUND" ]; then
          echo "âŒ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ debug=True Ð² ÐºÐ¾Ð´Ðµ!"
          echo "$DEBUG_FOUND"
          echo "debug_detected=true" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "âœ… Debug Ñ€ÐµÐ¶Ð¸Ð¼ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÐºÐ¾Ð´Ðµ"
          echo "debug_detected=false" >> $GITHUB_OUTPUT
        fi
    
    # 3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð´ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
    - name: Check for Hardcoded Secrets
      run: |
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð´ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²..."
        SECRET_PATTERNS="SECRET_KEY\|DATABASE_URL\|FLASK_DEBUG\|password"
        FOUND_SECRETS=$(grep -r -i "$SECRET_PATTERNS" . \
          --include="*.py" \
          --include="*.env.example" \
          --include="*.env" \
          --exclude-dir=.git \
          --exclude-dir=__pycache__ \
          --exclude-dir=.github || true)
        
        if echo "$FOUND_SECRETS" | grep -q "password\|admin\|test"; then
          echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹:"
          echo "$FOUND_SECRETS" | head -20
        else
          echo "âœ… ÐŸÐ¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        fi
    
    # 4. Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð²
    - name: Run Application Tests
      run: |
        echo "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ñ‚ÐµÑÑ‚Ð¾Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
        echo "SECRET_KEY=test_key" > .env
        echo "DATABASE_URL=sqlite:///test.db" >> .env
        echo "FLASK_DEBUG=False" >> .env
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚
        python -c "
        from app import app
        print('âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾')
                "
                
                # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð‘Ð”
                python create_user_table.py
                echo "âœ… Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð·Ð´Ð°Ð½Ð°"
            
            # 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°
            - name: Check for Vulnerable Code
              run: |
                echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° SQL-Ð¸Ð½ÑŠÐµÐºÑ†Ð¸Ð¸ Ð² ÐºÐ¾Ð´Ðµ..."
                
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÐºÐ¾Ð½ÐºÐ°Ñ‚ÐµÐ½Ð°Ñ†Ð¸Ð¸ ÑÑ‚Ñ€Ð¾Ðº Ð² SQL
                SQL_CONCAT=$(grep -r "f\"" . --include="*.py" | grep -i "select\|insert\|update\|delete" || true)
                
                if [ -n "$SQL_CONCAT" ]; then
                  echo "âš ï¸  ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ SQL-Ð¸Ð½ÑŠÐµÐºÑ†Ð¸Ð¸:"
                  echo "$SQL_CONCAT"
                else
                  echo "âœ… SQL-Ð¸Ð½ÑŠÐµÐºÑ†Ð¸Ð¸ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹"
                fi
            
            # 6. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
            - name: Generate Security Report
              if: always()
              run: |
                echo "ðŸ“Š === ÐžÐ¢Ð§Ð•Ð¢ ÐŸÐž Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ¡Ð¢Ð˜ ===" > security-summary.txt
                echo "Ð”Ð°Ñ‚Ð°: $(date)" >> security-summary.txt
                echo "Ð’ÐµÑ‚ÐºÐ°: ${{ github.ref }}" >> security-summary.txt
                echo "ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚: ${{ github.sha }}" >> security-summary.txt
                echo "" >> security-summary.txt
                echo "ðŸ“ˆ Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« ÐŸÐ ÐžÐ’Ð•Ð ÐžÐš:" >> security-summary.txt
                echo "------------------------" >> security-summary.txt
                echo "- Bandit SAST: ${{ steps.bandit_scan.outputs.warning_detected == 'false' && 'âœ… PASS' || 'âš ï¸ WARNING' }}" >> security-summary.txt
                echo "- Debug Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°: ${{ steps.debug_check.outputs.debug_detected == 'false' && 'âœ… PASS' || 'âŒ FAIL' }}" >> security-summary.txt
                echo "" >> security-summary.txt
                echo "ðŸ”§ Ð Ð•ÐšÐžÐœÐ•ÐÐ”ÐÐ¦Ð˜Ð˜:" >> security-summary.txt
                echo "----------------" >> security-summary.txt
                echo "1. Ð’ÑÐµÐ³Ð´Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ debug=False Ð² production" >> security-summary.txt
                echo "2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²" >> security-summary.txt
                echo "3. Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐ¹Ñ‚Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸" >> security-summary.txt
                echo "4. ÐŸÑ€Ð¾Ð²Ð¾Ð´Ð¸Ñ‚Ðµ Ð¿ÐµÐ½Ñ‚ÐµÑÑ‚Ñ‹ Ð¿ÐµÑ€ÐµÐ´ Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð¼" >> security-summary.txt
                
                cat security-summary.txt
            
            # 7. Upload Ð¾Ñ‚Ñ‡ÐµÑ‚ ÐºÐ°Ðº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚
            - name: Upload Security Report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                name: security-reports
                path: |
                  bandit-report.txt
                  security-summary.txt
                retention-days: 30