name: Security Scan

on:
  # –¢–û–õ–¨–ö–û –¥–ª—è Pull Request –≤ main –∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
  pull_request:
    branches: [ main, master ]
    types: [ opened, synchronize, reopened ]  # –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ PR
  schedule:
    - cron: '0 0 * * 0'  # –†–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –≤ –ø–æ–ª–Ω–æ—á—å

jobs:
  security:
    name: üîí Security Checks
    runs-on: ubuntu-latest
    
    # –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è Pull Request - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    permissions:
      contents: read
      pull-requests: read
    
    steps:
    - name: üì• Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤
    
    - name: üêç Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: üì¶ Install dependencies
      run: |
        python -m pip install --upgrade pip
        # –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        pip install bandit flask flask-sqlalchemy flask-wtf python-dotenv
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫
        pip install safety  # –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö
    
        # ========== 1. SAST –°–ö–ê–ù BANDIT ==========
    - name: üîç Run Bandit SAST Scan
      id: bandit
      continue-on-error: true  # –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ß–ö–£! –ù–µ –ø–∞–¥–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Bandit
      run: |
        echo "üö® –ó–∞–ø—É—Å–∫ Bandit —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏..."
        
        # –£–ü–†–û–©–ï–ù–ù–ê–Ø –ö–û–ú–ê–ù–î–ê –ë–ï–ó –õ–ò–®–ù–ò–• –ê–†–ì–£–ú–ï–ù–¢–û–í
        bandit -r . -f html -o bandit-report.html --skip B101,B404,B603 || true
        
        echo "‚ÑπÔ∏è  Bandit —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ (—Ä–µ–∂–∏–º 'continue-on-error')."
        echo "result=SCANNED" >> $GITHUB_OUTPUT
    
        # ========== 2. –ü–†–û–í–ï–†–ö–ê DEBUG –†–ï–ñ–ò–ú–ê ==========
    - name: üö´ Check for Debug Mode
      id: debug_check
      continue-on-error: true  # –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ß–ö–£!
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ debug —Ä–µ–∂–∏–º–∞ –≤ –∫–æ–¥–µ..."
        if grep -r "debug\s*=\s*True" . --include="*.py"; then
          echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –û–±–Ω–∞—Ä—É–∂–µ–Ω debug=True –≤ –∫–æ–¥–µ!"
          echo "debug_found=true" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ Debug —Ä–µ–∂–∏–º –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω"
          echo "debug_found=false" >> $GITHUB_OUTPUT
        fi
    
    # ========== 3. –ü–†–û–í–ï–†–ö–ê –°–ï–ö–†–ï–¢–û–í ==========
    - name: üîë Check for Hardcoded Secrets
      id: secrets_check
      continue-on-error: true  # –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º
      run: |
        echo "üîê –ü–æ–∏—Å–∫ —Ö–∞—Ä–¥–∫–æ–¥ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ..."
        
        # –û–ø–∞—Å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        DANGEROUS_PATTERNS=(
          "password\s*=\s*['\"].+['\"]"
          "secret_key\s*=\s*['\"].+['\"]"
          "api_key\s*=\s*['\"].+['\"]"
          "token\s*=\s*['\"].+['\"]"
          "admin.*['\"].*['\"]"
          "root.*['\"].*['\"]"
        )
        
        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
          echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞: $pattern"
          grep -r -n -i "$pattern" . \
            --include="*.py" \
            --exclude-dir=.git \
            --exclude-dir=__pycache__ \
            --exclude-dir=node_modules || true
        done
        
        echo "‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã—à–µ—É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤."
    
    # ========== 4. –ü–†–û–í–ï–†–ö–ê SQL-–ò–ù–™–ï–ö–¶–ò–ô ==========
    - name: üõ°Ô∏è Check for SQL Injection Patterns
      id: sql_check
      continue-on-error: true  # –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ß–ö–£!
      run: |
        echo "üíâ –ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö SQL-–∏–Ω—ä–µ–∫—Ü–∏–π..."
        if grep -r "f\".*SELECT\|f\".*INSERT\|f\".*UPDATE" . --include="*.py"; then
          echo "‚ùå –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã!"
          echo "sql_found=true" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã"
          echo "sql_found=false" >> $GITHUB_OUTPUT
        fi
    
        # ========== 5. –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    - name: üß™ Test Application Startup
      id: app_test
      run: |
        echo "üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
        
        # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
        export SECRET_KEY="test_secret_key_for_ci"
        export DATABASE_URL="sqlite:///test_ci.db"
        export FLASK_DEBUG="False"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –ë–î –í–ù–£–¢–†–ò –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        if python -c "
        import sys
        sys.path.append('.')
        from app import app
        from models import db

        print('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ')

        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: —Å–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        with app.app_context():
            print('‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω')
            db.create_all()
            print('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞')
                "; then
                  echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–π–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ"
                  echo "app_test=SUCCESS" >> $GITHUB_OUTPUT
                else
                  echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
                  echo "app_test=FAILED" >> $GITHUB_OUTPUT
                  exit 1
                fi
    
    # ========== 6. –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê ==========
    - name: üìä Generate Security Report
      if: always()
      run: |
        echo "üìã ================================="
        echo "üìã     –û–¢–ß–ï–¢ –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò"
        echo "üìã ================================="
        echo ""
        echo "üìÖ –î–∞—Ç–∞: $(date)"
        echo "üîó PR: ${{ github.event.pull_request.html_url || 'N/A' }}"
        echo "üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"
        echo "üîÑ –í–µ—Ç–∫–∞: ${{ github.head_ref || github.ref }}"
        echo ""
        echo "üìà –†–ï–ó–£–õ–¨–¢–ê–¢–´:"
        echo "--------------------------------"
        
        # Bandit —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ "${{ steps.bandit.outputs.result }}" = "PASSED" ]; then
          echo "üîí Bandit SAST: ‚úÖ –ü–†–û–ô–î–ï–ù–û"
        elif [ "${{ steps.bandit.outputs.result }}" = "FAILED" ]; then
          echo "üîí Bandit SAST: ‚ùå –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–û - –Ω–∞–π–¥–µ–Ω—ã —É—è–∑–≤–∏–º–æ—Å—Ç–∏"
        else
          echo "üîí Bandit SAST: ‚ö™ –ü–†–û–ü–£–©–ï–ù–û"
        fi
        
        # Debug –ø—Ä–æ–≤–µ—Ä–∫–∞
        if [ "${{ steps.debug_check.outputs.debug_found }}" = "false" ]; then
          echo "üêõ Debug —Ä–µ–∂–∏–º: ‚úÖ –ù–ï –ù–ê–ô–î–ï–ù"
        else
          echo "üêõ Debug —Ä–µ–∂–∏–º: ‚ùå –ù–ê–ô–î–ï–ù - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞"
        fi
        
        # SQL –ø—Ä–æ–≤–µ—Ä–∫–∞
        if [ "${{ steps.sql_check.outputs.sql_found }}" = "false" ]; then
          echo "üíâ SQL –∏–Ω—ä–µ–∫—Ü–∏–∏: ‚úÖ –ù–ï –ù–ê–ô–î–ï–ù–´"
        else
          echo "üíâ SQL –∏–Ω—ä–µ–∫—Ü–∏–∏: ‚ùå –ù–ê–ô–î–ï–ù–´ - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞"
        fi
        
        # –¢–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        if [ "${{ steps.app_test.outputs.app_test }}" = "SUCCESS" ]; then
          echo "üöÄ –¢–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ‚úÖ –£–°–ü–ï–®–ù–û"
        else
          echo "üöÄ –¢–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ‚ùå –û–®–ò–ë–ö–ê"
        fi
        
        echo ""
        echo "üìå –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
        echo "--------------------------------"
        echo "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã"
        echo "2. –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥–µ"
        echo "3. –í—Å–µ–≥–¥–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ debug=False –≤ production"
        echo "4. –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
        echo ""
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –≤ —Ñ–∞–π–ª
        echo "üìã =================================" > security_summary.md
        echo "üìã     –û–¢–ß–ï–¢ –ü–û –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò" >> security_summary.md
        echo "üìã =================================" >> security_summary.md
        echo "" >> security_summary.md
        echo "**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:**" >> security_summary.md
        echo "" >> security_summary.md
        echo "- **Bandit SAST:** ${{ steps.bandit.outputs.result || 'N/A' }}" >> security_summary.md
        echo "- **Debug —Ä–µ–∂–∏–º:** ${{ steps.debug_check.outputs.debug_found == 'false' && '‚úÖ –ù–µ –Ω–∞–π–¥–µ–Ω' || '‚ùå –ù–∞–π–¥–µ–Ω' }}" >> security_summary.md
        echo "- **SQL –∏–Ω—ä–µ–∫—Ü–∏–∏:** ${{ steps.sql_check.outputs.sql_found == 'false' && '‚úÖ –ù–µ –Ω–∞–π–¥–µ–Ω—ã' || '‚ùå –ù–∞–π–¥–µ–Ω—ã' }}" >> security_summary.md
        echo "- **–¢–µ—Å—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:** ${{ steps.app_test.outputs.app_test || 'N/A' }}" >> security_summary.md
    
    # ========== 7. –ó–ê–ì–†–£–ó–ö–ê –ê–†–¢–ï–§–ê–ö–¢–û–í ==========
    - name: üì§ Upload Security Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-reports-${{ github.run_number }}
        path: |
          bandit-report.html
          security_summary.md
        retention-days: 30


        # ========== 8. –§–ò–ö–°: –°–û–ó–î–ê–ù–ò–ï –°–¢–ê–¢–£–°-–ß–ï–ö–ê ==========
    - name: ‚úÖ Create Status Check
      if: always()  # –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º, –¥–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —à–∞–≥–∏ —É–ø–∞–ª–∏
      run: |
        # –ü—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ–º —à–∞–≥ - —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        echo "Workflow Security Scan –∑–∞–≤–µ—Ä—à–µ–Ω —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º: ${{ job.status }}"
        # –ì–ª–∞–≤–Ω–æ–µ - –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –º—ã —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å —Ä–∞–Ω–µ–µ